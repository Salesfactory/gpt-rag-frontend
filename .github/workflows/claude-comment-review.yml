name: Claude PR Code Review

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

jobs:
  review:
    if: >-
      ${{
        contains(github.event.comment.body, '@claude') &&
        (github.event.issue.pull_request != null || github.event.pull_request != null)
      }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write
    steps:
      - name: Get PR details
        id: pr_details
        run: |
          if [ "${{ github.event_name }}" == "issue_comment" ]; then
            PR_NUM=${{ github.event.issue.number }}
          else
            PR_NUM=${{ github.event.pull_request.number }}
          fi
          echo "pr_number=$PR_NUM" >> $GITHUB_OUTPUT

          # Get PR branch name using API (doesn't require checkout)
          PR_BRANCH=$(gh api repos/${{ github.repository }}/pulls/$PR_NUM --jq '.head.ref')
          echo "pr_branch=$PR_BRANCH" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr_details.outputs.pr_branch }}
          fetch-depth: 0

      - name: Check available models
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_CODE_REVIEW_API_KEY }}
        run: |
          echo "Checking available Anthropic models..."
          curl -s https://api.anthropic.com/v1/models \
            -H "anthropic-version: 2023-06-01" \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            | jq '.data[] | {id, display_name}'

      - name: Run Claude Code Review
        uses: anthropics/claude-code-action@v1
        with:
          show_full_output: true
          anthropic_api_key: ${{ secrets.ANTHROPIC_CODE_REVIEW_API_KEY }}
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.issue.number || github.event.pull_request.number }}

            You are performing a code review on this pull request. Review the changes thoroughly and provide actionable feedback.
            Before reviewing, read `ENGINEERING_STANDARDS.md` and `CLAUDE.md` at the repo root for full project context.

            ## Review Scope

            ### 1. Testing Coverage
            - Identify new functions/endpoints without corresponding unit tests
            - Frontend: tests must be co-located (`Component.test.tsx` next to `Component.tsx`)
            - Backend: tests in `backend/tests/test_*.py`, use the `FakeContainer` pattern for Cosmos DB mocking
            - Verify edge cases are tested: empty data, boundary conditions, null values
            - Check for missing E2E tests on user-facing features (Cypress in `frontend/cypress/e2e/`)

            ### 2. Backend Code (Python/Flask)
            - **Route Structure:** Routes must use Flask blueprints. Protected routes must have `@auth_required`. Decorator order: `@bp.route` → `@auth_required` → `@check_limits`
            - **Authorization:** Every route accessing org data must extract `organization_id` via `_require_organization_id()` and verify org membership
            - **Cosmos DB:** All queries must be parameterized (use `@org_id` style parameters, not string concatenation). Always supply the partition key (`organization_id`). Flag any `enable_cross_partition_query=True` without justification
            - **Error Handling:** Use `create_error_response()` for errors and `create_success_response()` for success responses. Use custom exceptions from `shared/error_handling.py`. Include machine-readable error codes (e.g., `MISSING_REQUIRED_FIELD`)
            - **Bugs:** Off-by-one errors, date/time calculation issues, timezone handling
            - **Security:** Missing `@auth_required` on protected routes, Cosmos DB query injection (unparameterized queries), input validation gaps, error message information disclosure, path traversal in file operations
            - **Performance:** Missing `@lru_cache` on Azure client instantiation, unnecessary cross-partition queries, missing partition keys, unbounded result sets
            - **Style:** Use f-strings for all string formatting (never `%` or `.format()`). Use type hints on public function signatures

            ### 3. Frontend Code (React/TypeScript)
            - **API Calls:** Must use `fetchWrapper` (not raw `fetch` or `axios`) — it handles 401/session expiration automatically. Handle errors at the call site with try-catch
            - **Error Handling:** Use `toast.error()` for user-facing errors, `debugLog()` for development logging. Never use `console.log`/`console.error` directly. Error boundaries required for components that could crash
            - **Security:** All rendered HTML must be sanitized with DOMPurify — flag any `dangerouslySetInnerHTML` without it
            - **Structure:** Components over 400 lines should be flagged for splitting. Co-locate styles as CSS Modules (`Component.module.css`). One exported component per file
            - **State Management:** Use `useReducer` for complex multi-step flows. Wrap expensive computations in `useMemo`. Wrap event handlers passed to children in `useCallback`
            - **Effects:** Every `useEffect` that fetches data must use `AbortController` for cleanup. Always clean up timeouts and subscriptions
            - **TypeScript:** No `any` without a justifying comment. Prefer discriminated unions over multiple booleans. Use type guards over type assertions
            - **Performance:** Missing `useMemo`/`useCallback`, unnecessary re-renders, missing `React.lazy()` for heavy routes
            - **Accessibility (WCAG 2.1 AA):** ARIA labels on interactive elements, keyboard navigation support, color contrast, screen reader compatibility, `@media (prefers-reduced-motion: reduce)` for animations

            ### 4. Integration
            - TypeScript interfaces in `src/api/models.ts` must match backend response shapes
            - Backend must return standardized format: `{ data, status }` for success, `{ error: { message, status, code } }` for errors
            - Error codes must be consistent between backend constants and frontend error handling
            - Consistent field naming between frontend (camelCase) and backend (snake_case)
            - New API route prefixes must be added to `vite.config.ts` proxy config

            ## Output Format

            For each issue found, provide:

            **Issue:** [Brief description]

            **Recommended Fix:**
            ```
            // Concrete code example showing the fix
            ```

            **Impact:** [What could go wrong if not fixed]

            ---

            ## Review Priorities

            1. **Critical:** Security vulnerabilities (missing auth, unsanitized HTML, unparameterized queries), data corruption risks, authorization bypasses
            2. **High:** Missing tests for new logic, performance bottlenecks, accessibility blockers
            3. **Medium:** Code quality issues, missing error handling, inconsistent patterns
            4. **Low:** Style inconsistencies, minor optimizations

            ## Guidelines

            - All **Cosmos DB queries must be parameterized** — flag any string concatenation in queries
            - Protected routes must have **`@auth_required`** and verify **org membership**
            - Use **`fetchWrapper`** for all frontend API calls — flag raw `fetch` or `axios`
            - Use **`create_error_response()`** / **`create_success_response()`** — flag raw `jsonify` in route handlers
            - Use **f-strings** for string formatting in Python — flag `%`-formatting or `.format()`
            - Use **`debugLog()`** for dev logging and **`toast.error()`** for user-facing errors — flag `console.log`/`console.error`
            - **Sanitize HTML with DOMPurify** before rendering — flag unguarded `dangerouslySetInnerHTML`
            - React components over **400 lines** should be flagged for splitting
            - Functions over **200 lines** should be flagged for splitting
            - Interactive elements need **ARIA labels** and keyboard support
            - Magic numbers should be **named constants**
            - **CSS Modules** must be co-located with their component (`Component.module.css`)

            Focus on issues that matter. Skip nitpicks unless they indicate a pattern.
            Only comment on files changed in this PR. Keep feedback concise and actionable.
            Note: The PR branch is already checked out in the current working directory.

            Use `gh pr comment` for top-level feedback.
            Use `mcp__github_inline_comment__create_inline_comment` to highlight specific code issues.
            Only post GitHub comments - don't submit review text as messages.
          claude_args: |
            --model claude-sonnet-4-5-20250929
            --allowedTools "mcp__github_inline_comment__create_inline_comment,Bash(gh pr *),Bash(git *),Read,Grep,Glob"
